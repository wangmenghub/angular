/** * Created by ID on 16/1/23. * Author:zhoudd * email:zhoudd@stark.tm */angular.module('rsc.controllers.common', [])    .controller('ShareSMSCtrl', function ($scope, $cordovaClipboard, $sce, $location, $state, trade158, $stateParams, AccountInformation, PassService, $filter, $log, iAlert) {        $scope.type = $stateParams.type;        $scope.id = $stateParams.id;        var urlType = '';        //        var temp = {phone_target: '', name_target: '', comp_target: ''};        $scope.sms_info_list = [];        $scope.init = function () {            $scope.sms_info_list.push(temp);            switch ($scope.type) {                case 'tradeDemand':                    urlType = "trade_order";                    break;                case 'trafficDemand':                    urlType = "traffic_order";                    break;                case 'tradePlan':                    urlType = "trade_plan";                    break;                default:                    urlType = "";            }            //$scope.urlText = "http://" + $location.host() + ":" + $location.port() + "/#/tab/reg/" +            //    ($scope.type == "tradeDemand" ? "trade_order" : "traffic_order" )            //    + "/" + $scope.id;            $scope.urlText = "http://" + $location.host() + ":" + $location.port() + "/#/tab/reg/" +                urlType                + "/" + $scope.id;            switch ($scope.type) {                case 'trafficDemand':                    //TODO 获取发抢单公司的信息                    //return "#在日升昌平台发布一个物流需求，从#至#运送##万吨，快来日升昌平台抢单吧。退订回复TD";                    PassService.getSMSParams({demand_id: $scope.id}).then(function (result) {                        if (result.status == 'success') {                            $log.info('获取物流抢单的模板参数', result);                            result.data[4] = $filter('numberConvert')(result.data[4]);                            $scope.smstext = $sce.trustAsHtml($filter("smsTemplate")(result.data, $scope.type));                            $scope.content = result.data;                            $scope.content.push($scope.urlText);                            $log.info('短信内容', $scope.content);                        } else {                            $log.error('获取物流抢单的模板参数', $scope.content);                        }                    });                    $scope.template_id = "trade_send_traffic_demand";                    break;                case 'tradeDemand':                    $scope.content = [];                    //TODO 分享采购抢单                    trade158.getDemandDetail($scope.id).success(function (result) {                        if (result.status == 'success') {                            console.log(result);                            $scope.content.push(result.data.entry.company_name);                            $scope.content.push(result.data.entry.amount);                            $scope.content[1] = $filter('numberConvert')($scope.content[1]);                            $scope.content.push($scope.urlText);                            $scope.smstext = $sce.trustAsHtml($filter("smsTemplate")($scope.content, $scope.type));                        } else {                            $log.error('获取采购单信息失败', result)                        }                    })                    //return "#企业在日升昌平台采购##吨，邀请您前来报价。快快点击查看吧。退订回复TD";                    $scope.template_id = "trade_send_demand";                    break;                case 'register':                    //return "#企业采购负责人邀请您下载安装日升昌app，更多采购需求等你报价。点击下载：日升昌app。退订回复TD";                    $scope.template_id = "trade_purchase_invite";                    break;                case 'tradePlan':                    //return "#企业采购负责人邀请您下载安装日升昌app，更多采购需求等你报价。点击下载：日升昌app。退订回复TD";                    //$scope.template_id = "trade_purchase_invite";                    break;                default :            }        };        $scope.addContact = function () {            var temp = {phone_target: '', name_target: '', comp_target: ''};            //$scope.sms_info_list.join(temp);            $scope.sms_info_list.push(temp);        }        $scope.send = function () {            var postData = {};            postData.sms_info_list = $scope.sms_info_list;            postData.content = $scope.content;            postData.template_id = $scope.template_id;            postData.demand_id = $scope.id;            postData.type = $scope.type;            AccountInformation.shardForSMS(postData).then(function (result) {                if (result.status == 'success') {                    $log.info('发送短信', result);                    iAlert.alert('发送成功!')                } else {                    $log.error('发送短信失败', result);                    iAlert.alert('发送失败!点击发送重试!')                }            });        }        $scope.del = function (index) {            $scope.sms_info_list.splice(index, 1)        }        $scope.goBack = function () {            window.history.go(-1);        }        $scope.copyIndex = function () {            if (ionic.Platform.isWebView()) {                $cordovaClipboard                    .copy($scope.order.index)                    .then(function () {                        // success                        iAlert.alert('复制成功!');                    }, function () {                        // error                        iAlert.alert('复制失败!');                    });            }        }        $scope.showMessage = function () {            iAlert.alert('复制成功!')        }        $scope.fallback = function (copy) {            if (!ionic.Platform.isWebView()) {                window.prompt('请选中文字使用CTRL+C进行复制!', copy);            }        };    })