/** * Created by ID on 15/12/7. * Author:zhoudd * email:zhoudd@stark.tm */angular.module('rsc.service.pass', ['restangular', 'rsc.service.rest'])    .factory('PassService', function ($q, ENV, PassRestAngular, PassPayAngular, $http, AccountRestAngular) {        return {            /**             * 获取所有的货源的信息             * @param data             * @returns {*}             */            queryDemandList: function (data) {                var pass = PassRestAngular.oneUrl('demand/getList/' + data.all + '/' + data.order + '/' + data.pageSize);                return pass.get();            },            /**             * 根据ID获取物流货源的信息。             * @param id             * @returns {*}             */            getDemandById: function (id) {                var pass = PassRestAngular.allUrl('demand/get_one');                return pass.post({demand_id: id});            },            //获取需求单报价企业总数            getDemandOfferCountById: function (id) {                var count = PassRestAngular.allUrl('/demand/get_offer_count');                var data = {                    demand_id: id                }                return count.post(data);            },            offerCommit: function (data) {                var offer = PassRestAngular.allUrl('/offer/add');                return offer.post(data);            },            /**             * 物流公司修改物流抢单             *price, amount, style_payment, demand_id             * @returns {*}             */            offerEdit: function (data) {                var offer = PassRestAngular.allUrl('/offer/edit');                return offer.post(data);            },            getOfferList: function (data) {                var offerlist = PassRestAngular.allUrl('offer/get_by_demand_id');                return offerlist.post(data);            },            getAllAmount: function () {                var all = PassRestAngular.allUrl('/demand/get_all_amount');                return all.post();            },            /**             * 根据公司类型获取当前公司所有的订单。             * @param type             * @returns {*}             */            getAllOrders: function (type) {                var url = "/order/" + type.toLowerCase() + "_get";                var all = PassRestAngular.allUrl(url);                return all.post();                //http://192.168.3.147:18081/api/order/traffic_get            },            getOrderById: function (id) {                //http://192.168.3.147:18081/api/order/get_one                var all = PassRestAngular.allUrl('/order/get_one');                return all.post({order_id: id});            },            /**             *  物流公司1.5步确认订单             * @param order_id             * @returns {*}             */            orderStepTraffic_confirm: function (order_id) {                //order/2_add_traffic                var all = PassRestAngular.allUrl('/order/1_traffic_confirm');                return all.post({order_id: order_id});            },            /**             * 物流公司申请发车             * @param time             * @returns {*}             */            orderDispatchTruck: function (order_id, time) {                var all = PassRestAngular.allUrl('/order/2_apply_add_traffic_time');                return all.post({order_id: order_id, time: time});            },            /**             * 交易确认发车时间             * @param order_id             * @param time             * @returns {*}             */            orderConfirmDispatchTruckTime: function (order_id, time) {                var all = PassRestAngular.allUrl('/order/2_deal_add_traffic_time');                return all.post({order_id: order_id, time: time});            },            //            /**             * 物流订单选择车辆后确认             * @param array             * @returns {*}             */            orderStep2SelectCar: function (order_id, array) {                //order/2_add_traffic                var all = PassRestAngular.allUrl('/order/2_add_traffic');                return all.post({order_id: order_id, v_info: array});            },            getOrderUseCar: function (order_id) {                //route/get                var all = PassRestAngular.allUrl('/route/get');                return all.post({order_id: order_id});            },            /**             * 物流确认收预付款 后加2.25             * @param order_id             * @returns {*}             */            orderStep2Confirm: function (order_id) {                var all = PassRestAngular.allUrl('/order/2_traffic_confirm');                return all.post({order_id: order_id});            },            /**             * 第四步物流方确认             * @param order_id             * @param confirm false 表示确认，true 表示申请谅解             * @param price 当 confirm为false的时候可以不传，当为true传申请谅解的金额             * @returns {*}             */            orderStep4ApplyUnderstanding: function (order_id, confirm, price) {                var all = PassRestAngular.allUrl('/order/4_traffic_confirm');                return all.post({order_id: order_id, confirm: confirm, price: price});            },            orderStep3Confirm: function (data) {                var all = PassRestAngular.allUrl('/order/3_confirm');                return all.post(data);            },            getAllRouteByOrderId: function (order_id) {                var all = PassRestAngular.allUrl('/route/get');                return all.post({order_id: order_id});            },            /**             * 获取我的物流需求单             * @returns {*}             */            getAllDemand: function (data) {                var all = PassRestAngular.allUrl('/demand/get_by_role');                return all.post(data);            },            /**             * 销售选择物流单             * @param offer_id amount             * @returns {*}             */            selectOffer: function (data) {                var all = PassRestAngular.allUrl('offer/select');                return all.post(data);            },            /**             * 销售第一步确认订单             * @param order_id             * @returns {*}             */            passOrderConfirm: function (order_id) {                var all = PassRestAngular.allUrl('/order/1_confirm');                return all.post({order_id: order_id});            },            /**             * 销售公司确认收货             * @param order_id             */            tradeOrder4ConfirmReceipt: function (data) {                var all = PassRestAngular.allUrl('/order/4_buy_confirm');                return all.post(data);            },            /**             * 第五步 物流方确认收款             * @param order_id             * @returns {*}             */            trafficOrder5Confirm: function (order_id) {                var all = PassRestAngular.allUrl('/order/5_confirm');                return all.post({order_id: order_id});            },            trafficOrder4ReConfirm: function (order_id, confirm) {                var all = PassRestAngular.allUrl('/order/4_buy_reconfirm');                return all.post({order_id: order_id, confirm: confirm});            },            orderPay: function (type, order_id, file) {                //var formData = new FormData();                //formData.append('file', file);                //                //var url = '/file/upload/' + type + "/" + order_id;                //var all = PassPayAngular.allUrl(url);                //                //return all.post({transformRequest: angular.identity},formData);                var defer = $q.defer();                var formData = new FormData();                formData.append('file', file);                var url = ENV.api.pass + 'file/upload/' + type + "/" + order_id;                $http({                    method: 'POST'                    , url: url                    , data: formData                    , headers: {                        "Content-Type": undefined                    }                    , transformRequest: angular.identity                }).success(function (data) {                    if (data.status == "success") {                        defer.resolve(data);                    } else {                        defer.reject(data);                    }                }).error(function (error) {                    console.log(error)                });                return defer.promise;            },            payMentConfirm: function (order_id, url, step) {                var postUrl;                var postData = {order_id: order_id};                if (step == 2) {                    postUrl = "/order/2_upload_payment";                    postData.url = url;                } else if (step == 5) {                    postUrl = "/order/5_upload_payment";                    postData.url = url;                } else if (step == 4) {                    postUrl = "/order/4_buy_confirm";                    postData.url_remain_payment = url;                } else {                    postUrl = "";                }                var all = PassRestAngular.allUrl(postUrl);                return all.post(postData);            },            /**             * 仓库管理员获取未完成、已完成的订单列表             * @param store_id             * @param finish true 完成，false 未完成             * @returns {*}             */            getOrderForStorer: function (store_id, finish) {                var all = PassRestAngular.allUrl('order/get_storage_log');                return all.post({store_id: store_id, finish: finish});            },            /**             * 获取仓库信息             * @param store_id             * @returns {*}             */            getStores: function (store_id) {                var all = AccountRestAngular.allUrl('company_trade_store/get_one');                return all.post({store_id: store_id});            },            /**             * 编辑仓库信息             * @param store             * @returns {*}             */            editStore: function (store) {                var all = AccountRestAngular.allUrl('company_trade_store/edit');                return all.post(store);            },            /**             * 仓库过磅             * @param order_id 订单id             * @param user_id 过磅人             * @param number 吨数             * @returns {*}             * @constructor             */            storeWeigh: function (order_id, user_id, number) {                var all = PassRestAngular.allUrl('/order/3_sell_weigh');                return all.post({order_id: order_id, number: number, user_id: user_id});            },            storeWeighForBuy: function (order_id, user_id, number) {                var all = PassRestAngular.allUrl('/order/3_buy_weigh');                return all.post({order_id: order_id, number: number, user_id: user_id});            },            /**             * 判断当前公司是否已经对该订单             * @param demand_id             * @returns {canOffer 表示该公司是否能对该订单抢单,hasOffer是否已经抢过单了>0 表示已有报价}             */            getCompanyOfferCountByDemandId: function (demand_id) {                var all = PassRestAngular.allUrl('offer/get_company_offer_count_by_demand_id');                return all.post({demand_id: demand_id});            },            /**             * 根据Demand_id判断，当前用户是否有权操作             * @param demand_id             * @returns {*}             */            checkDemandAuthority: function (demand_id) {                var all = PassRestAngular.allUrl('demand/is_same_demand_user');                return all.post({demand_id: demand_id});            },            /**             * 车辆相关图片上传             * @param type             * @param truck_id             * @param file             * @returns {*}             */            carImgUpload: function (type, truck_id, file) {                //var formData = new FormData();                //formData.append('file', file);                //                //var url = '/file/upload/' + type + "/" + order_id;                //var all = PassPayAngular.allUrl(url);                //                //return all.post({transformRequest: angular.identity},formData);                var defer = $q.defer();                var formData = new FormData();                formData.append('file', file);                var url = ENV.api.account + 'file/upload/' + type + "/" + truck_id;                $http({                    method: 'POST'                    , url: url                    , data: formData                    , headers: {                        "Content-Type": undefined                    }                    , transformRequest: angular.identity                }).success(function (data) {                    if (data.status == "success") {                        defer.resolve(data);                    } else {                        defer.reject(data);                    }                }).error(function (error) {                    defer.reject(error);                });                return defer.promise;            },            /**             * 运输途中更换车辆             * @param order_id             * @param route_id             * @param truck_id             * @param user_id             * @returns {*}             */            replaceCar: function (data) {                var all = PassRestAngular.allUrl('route/replace');                //{order_id: order_id, route_id: route_id, truck_id: truck_id, user_id: user_id}                return all.post(data);            },            /**             * 根据抢单Id获取抢单详情             * @param offer_id             * @returns {*}             */            getOfferById: function (offer_id) {                var all = PassRestAngular.allUrl('offer/get_by_id');                //{order_id: order_id, route_id: route_id, truck_id: truck_id, user_id: user_id}                return all.post({offer_id: offer_id});            },            /**             * 获取物流公司的所有抢单列表             * @returns {*}             */            getOfferListByCompany: function (data) {                var all = PassRestAngular.allUrl('offer/get_by_role');                //{order_id: order_id, route_id: route_id, truck_id: truck_id, user_id: user_id}                return all.post(data);            },            /**             * 根据订单ID获取应到货、实际到货、未到货数量             * @param order_id             * @returns {*}             */            getAmountLast: function (order_id) {                var all = PassRestAngular.allUrl('order/get_amount_and_last');                return all.post({order_id: order_id});            },            /**             * 获取司机状态             * @param uesr_id             * @returns {*}             */            getDriverStateById: function (uesr_id) {                var all = PassRestAngular.allUrl('route/get_by_user_id');                return all.post({user_id: uesr_id});            },            /**             * 获取物流货源列表（新接口）queryDemandList（旧）             * @param data             * @returns {*}             */            passDemandFind: function (data) {                var all = PassRestAngular.allUrl('demand/find');                return all.post(data);            },            getSMSParams: function (data) {                var all = PassRestAngular.allUrl('demand/get_SMS_content_by_id');                return all.post(data);            },            /**             * 取消订单             * @param order_id             * @returns {*}             */            cancelOrder: function (order_id) {                var all = PassRestAngular.allUrl('order/cancel');                return all.post({order_id: order_id});            },            /**             * 根据订单id检查当前登陆公司是否可以抢单.             * @param order_id             * @returns {true:可以抢单,false:不可抢单}             */            checkOfferAuthority: function (demand_id) {                var all = PassRestAngular.allUrl('demand/can_offer');                return all.post({demand_id: demand_id});            },            getDriverOfferCount: function (order_id) {                ///api/driver_offer/count                //获取某笔订单司机抢单数                //order_id                var all = PassRestAngular.allUrl('driver_offer/count');                return all.post({order_id: order_id});            }        }    })    .factory('Reddit', function ($http) {        var Reddit = function () {            this.items = [];            this.busy = false;            this.after = '';        };        Reddit.prototype.nextPage = function () {            if (this.busy) return;            this.busy = true;            var url = "http://api.reddit.com/hot?after=" + this.after + "&jsonp=JSON_CALLBACK";            $http.jsonp(url).success(function (data) {                var items = data.data.children;                for (var i = 0; i < items.length; i++) {                    this.items.push(items[i].data);                }                this.after = "t3_" + this.items[this.items.length - 1].id;                this.busy = false;            }.bind(this));        };        return Reddit;    });